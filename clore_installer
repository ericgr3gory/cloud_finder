#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# clore_installer (Supervisor edition, HOME fixed, + uploader)
#
# - Installs OpenCL loader + tools
# - Installs Hashcat 7.1.2 to /home/hashcat/hashcat-7.1.2
# - Symlinks /usr/local/bin/hashcat -> hashcat.bin
# - Creates /home/hashcat/.hashcat/* layout
# - Clones/updates https://github.com/ericgr3gory/cloud_finder.git
# - Creates venv + installs requirments.txt
# - Adds TWO supervisor programs:
#     1) hashkitty-worker   -> gpu-consumer.py
#     2) hashkitty-uploader -> redis_upload_feeder.py
# - Fixes HOME so "~/.hashcat" resolves to /home/hashcat, not /root
#
# FIXES ADDED:
# - Make ALL files/dirs under HASHCAT_OPT_DIR owned by user "hashcat"
# - Create compatibility symlink:
#     /home/ericgr3gory/.hashcat  ->  /home/hashcat/.hashcat
#   so jobs containing /home/ericgr3gory/.hashcat/* paths run on rentals.
# ============================================================

### --- CONFIG ---
HASHCAT_VER="7.1.2"
HASHCAT_7Z_URL="https://hashcat.net/files/hashcat-${HASHCAT_VER}.7z"
HASHCAT_OPT_DIR="/home/hashcat/hashcat-${HASHCAT_VER}"
HASHCAT_SYMLINK="/usr/local/bin/hashcat"

WORKER_USER="hashcat"
WORKER_HOME="/home/${WORKER_USER}"
HASHCAT_DOTDIR="${WORKER_HOME}/.hashcat"

# Compatibility user home expected by some jobs
COMPAT_USER="ericgr3gory"
COMPAT_HOME="/home/${COMPAT_USER}"
COMPAT_HASHCAT="${COMPAT_HOME}/.hashcat"

REPO_URL="https://github.com/ericgr3gory/cloud_finder.git"
REPO_DIR="${WORKER_HOME}/cloud_finder"
VENV_DIR="${REPO_DIR}/.venv"
REQ_FILE="${REPO_DIR}/requirments.txt"  # keep your spelling

SUP_CONF_WORKER="/etc/supervisor/conf.d/hashkitty-worker.conf"
SUP_CONF_UPLOADER="/etc/supervisor/conf.d/hashkitty-uploader.conf"

# Toggle uploader feeder
ENABLE_UPLOADER="yes"  # yes|no

log(){ echo -e "\n[+] $*\n"; }
warn(){ echo -e "\n[!] $*\n" >&2; }
die(){ echo -e "\n[✗] $*\n" >&2; exit 1; }

need_root() {
  [[ "${EUID}" -eq 0 ]] || die "Run as root: sudo bash $0"
}

apt_update_once() {
  export DEBIAN_FRONTEND=noninteractive
  if [[ -z "${_APT_UPDATED:-}" ]]; then
    apt-get update -y
    _APT_UPDATED=1
  fi
}

install_packages() {
  log "Installing packages (OpenCL loader, python, git, 7z, supervisor tools)..."
  apt_update_once
  apt-get install -y \
    ocl-icd-libopencl1 \
    clinfo \
    p7zip-full \
    python3 \
    python3-venv \
    python3-pip \
    git \
    wget \
    ca-certificates \
    redis-tools \
    tmux \
    supervisor
}

ensure_user() {
  if id -u "${WORKER_USER}" >/dev/null 2>&1; then
    log "User ${WORKER_USER} already exists."
  else
    log "Creating user ${WORKER_USER}..."
    useradd -m -s /bin/bash "${WORKER_USER}"
  fi
}

make_dirs() {
  log "Creating ${HASHCAT_DOTDIR} directory layout..."
  mkdir -p \
    "${HASHCAT_DOTDIR}/hashz" \
    "${HASHCAT_DOTDIR}/cracked" \
    "${HASHCAT_DOTDIR}/dictionaries" \
    "${HASHCAT_DOTDIR}/hashcat-restores" \
    "${HASHCAT_DOTDIR}/jobs" \
    "${HASHCAT_DOTDIR}/logs" \
    "${HASHCAT_DOTDIR}/masks" \
    "${HASHCAT_DOTDIR}/pots" \
    "${HASHCAT_DOTDIR}/rules" \
    "${HASHCAT_DOTDIR}/sessions" \
    "${HASHCAT_DOTDIR}/tools" \
    "${HASHCAT_DOTDIR}/uploads"

  chown -R "${WORKER_USER}:${WORKER_USER}" "${WORKER_HOME}"
}

link_compat_hashcat_home() {
  # Make /home/ericgr3gory/.hashcat/* resolve to /home/hashcat/.hashcat/*
  # so jobs with hard-coded /home/ericgr3gory paths work on rentals.
  log "Linking compatibility path: ${COMPAT_HASHCAT} -> ${HASHCAT_DOTDIR}"

  mkdir -p "${COMPAT_HOME}"

  # If something already exists at /home/ericgr3gory/.hashcat and it's NOT a symlink,
  # move it aside rather than deleting it.
  if [[ -e "${COMPAT_HASHCAT}" && ! -L "${COMPAT_HASHCAT}" ]]; then
    local ts
    ts="$(date +%Y%m%d_%H%M%S)"
    warn "${COMPAT_HASHCAT} exists and is not a symlink. Moving to ${COMPAT_HASHCAT}.bak.${ts}"
    mv "${COMPAT_HASHCAT}" "${COMPAT_HASHCAT}.bak.${ts}"
  fi

  # Create/replace symlink
  ln -sfn "${HASHCAT_DOTDIR}" "${COMPAT_HASHCAT}"

  # Ownership of /home/ericgr3gory itself isn't critical for the symlink to work,
  # but keep it sane:
  chown -R root:root "${COMPAT_HOME}" || true
}

install_hashcat() {
  log "Downloading Hashcat ${HASHCAT_VER}..."
  cd /tmp
  rm -f "hashcat-${HASHCAT_VER}.7z"
  wget -O "hashcat-${HASHCAT_VER}.7z" "${HASHCAT_7Z_URL}"

  log "Extracting Hashcat..."
  rm -rf "hashcat-${HASHCAT_VER}"
  7z x "hashcat-${HASHCAT_VER}.7z" >/dev/null

  log "Installing Hashcat to ${HASHCAT_OPT_DIR}..."
  rm -rf "${HASHCAT_OPT_DIR}"
  mv "hashcat-${HASHCAT_VER}" "${HASHCAT_OPT_DIR}"

  log "Symlinking ${HASHCAT_SYMLINK} -> ${HASHCAT_OPT_DIR}/hashcat.bin"
  ln -sfn "${HASHCAT_OPT_DIR}/hashcat.bin" "${HASHCAT_SYMLINK}"
}

fix_hashcat_install_ownership() {
  log "Making ALL of ${HASHCAT_OPT_DIR} owned by ${WORKER_USER}:${WORKER_USER} ..."
  chown -R "${WORKER_USER}:${WORKER_USER}" "${HASHCAT_OPT_DIR}"

  # Ensure directories are traversable and files readable; give user write everywhere.
  # If you want tighter perms (no world-readable), tell me and I'll adjust.
  chmod -R u+rwX,go+rX "${HASHCAT_OPT_DIR}"
}

clone_or_update_repo() {
  log "Cloning/updating repo into ${REPO_DIR}..."
  if [[ -d "${REPO_DIR}/.git" ]]; then
    (cd "${REPO_DIR}" && git pull --ff-only)
  else
    rm -rf "${REPO_DIR}"
    runuser -u "${WORKER_USER}" -- git clone "${REPO_URL}" "${REPO_DIR}"
  fi
  chown -R "${WORKER_USER}:${WORKER_USER}" "${REPO_DIR}"
}

setup_venv() {
  log "Creating Python venv at ${VENV_DIR}..."
  runuser -u "${WORKER_USER}" -- python3 -m venv "${VENV_DIR}"

  if [[ -f "${REQ_FILE}" ]]; then
    log "Installing Python requirements from ${REQ_FILE}..."
    runuser -u "${WORKER_USER}" -- bash -lc "
      set -e
      source '${VENV_DIR}/bin/activate'
      pip install -U pip
      pip install -r '${REQ_FILE}'
    "
  else
    warn "Requirements file not found: ${REQ_FILE}"
    warn "Your repo must contain requirments.txt or update REQ_FILE."
  fi
}

write_supervisor_worker() {
  log "Writing Supervisor program: hashkitty-worker (gpu-consumer.py)"

  mkdir -p "${HASHCAT_DOTDIR}/logs"
  chown -R "${WORKER_USER}:${WORKER_USER}" "${HASHCAT_DOTDIR}"

  cat > "${SUP_CONF_WORKER}" <<EOF
[program:hashkitty-worker]
directory=${REPO_DIR}
command=${VENV_DIR}/bin/python ${REPO_DIR}/gpu-consumer.py
user=${WORKER_USER}

; CRITICAL: make ~ expand to /home/hashcat (not /root)
environment=HOME="${WORKER_HOME}",USER="${WORKER_USER}",LOGNAME="${WORKER_USER}"

autostart=true
autorestart=true
startretries=999
stopsignal=TERM
stopasgroup=true
killasgroup=true

stdout_logfile=${HASHCAT_DOTDIR}/logs/worker.out
stderr_logfile=${HASHCAT_DOTDIR}/logs/worker.err
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
EOF
}

write_supervisor_uploader() {
  [[ "${ENABLE_UPLOADER}" == "yes" ]] || { log "ENABLE_UPLOADER=no, skipping uploader feeder."; return 0; }

  log "Writing Supervisor program: hashkitty-uploader (redis_upload_feeder.py)"

  cat > "${SUP_CONF_UPLOADER}" <<EOF
[program:hashkitty-uploader]
directory=${REPO_DIR}
command=${VENV_DIR}/bin/python ${REPO_DIR}/redis_upload_feeder.py
user=${WORKER_USER}

; CRITICAL: make ~ expand to /home/hashcat (not /root)
environment=HOME="${WORKER_HOME}",USER="${WORKER_USER}",LOGNAME="${WORKER_USER}"

autostart=true
autorestart=true
startretries=999
stopsignal=TERM
stopasgroup=true
killasgroup=true

stdout_logfile=${HASHCAT_DOTDIR}/logs/uploader.out
stderr_logfile=${HASHCAT_DOTDIR}/logs/uploader.err
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=5
EOF
}

reload_supervisor() {
  log "Reloading Supervisor..."
  supervisorctl reread
  supervisorctl update

  # Restart both if present
  supervisorctl restart hashkitty-worker || true
  if [[ "${ENABLE_UPLOADER}" == "yes" ]]; then
    supervisorctl restart hashkitty-uploader || true
  fi

  log "Supervisor status:"
  supervisorctl status || true
}

post_notes() {
  log "Done. Quick checks:"
  echo "  nvidia-smi"
  echo "  hashcat --version"
  echo "  hashcat -I"
  echo
  echo "Supervisor:"
  echo "  supervisorctl status"
  echo
  echo "Ownership sanity:"
  echo "  ls -ld ${HASHCAT_OPT_DIR}"
  echo "  sudo -u ${WORKER_USER} test -w ${HASHCAT_OPT_DIR}/kernels && echo 'hashcat can write kernels ✅'"
  echo
  echo "Compat symlink sanity:"
  echo "  ls -la ${COMPAT_HOME}"
  echo "  ls -la ${COMPAT_HASHCAT}"
  echo
  echo "Logs:"
  echo "  tail -f ${HASHCAT_DOTDIR}/logs/worker.out"
  echo "  tail -f ${HASHCAT_DOTDIR}/logs/worker.err"
  if [[ "${ENABLE_UPLOADER}" == "yes" ]]; then
    echo "  tail -f ${HASHCAT_DOTDIR}/logs/uploader.out"
    echo "  tail -f ${HASHCAT_DOTDIR}/logs/uploader.err"
  fi
}

main() {
  need_root
  install_packages
  ensure_user
  make_dirs
  link_compat_hashcat_home
  install_hashcat
  fix_hashcat_install_ownership
  clone_or_update_repo
  setup_venv
  write_supervisor_worker
  write_supervisor_uploader
  reload_supervisor
  post_notes
}

main "$@"
