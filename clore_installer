#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# clore_gpu_worker_setup.sh
#
# GPU worker box for Clore:
#  - installs CUDA toolkit (as you requested)
#  - installs Hashcat 7.1.2 into /opt + symlink /usr/local/bin/hashcat
#  - creates /home/hashcat/.hashcat/* layout
#  - git clone your cloud_finder repo into /home/hashcat/cloud_finder
#  - creates venv and installs requirments.txt
#  - OPTIONAL: systemd service to run gpu-consumer.py at boot
#
# ASSUMPTION: Redis is reachable on the worker at 127.0.0.1:6379 via SSH tunnel.
# ============================================================

### --- CONFIG ---
HASHCAT_VER="7.1.2"
HASHCAT_7Z_URL="https://hashcat.net/files/hashcat-${HASHCAT_VER}.7z"
HASHCAT_OPT_DIR="/opt/hashcat-${HASHCAT_VER}"
HASHCAT_SYMLINK="/usr/local/bin/hashcat"

WORKER_USER="hashcat"
WORKER_HOME="/home/${WORKER_USER}"
HASHCAT_DOTDIR="${WORKER_HOME}/.hashcat"

REPO_URL="https://github.com/ericgr3gory/cloud_finder.git"
REPO_DIR="${WORKER_HOME}/cloud_finder"
VENV_DIR="${REPO_DIR}/.venv"
REQ_FILE="${REPO_DIR}/requirments.txt"  # keep your spelling

# If you want the GPU worker to auto-start on reboot:
INSTALL_SYSTEMD="yes"   # yes|no

### --- helpers ---
log(){ echo -e "\n[+] $*\n"; }
warn(){ echo -e "\n[!] $*\n" >&2; }
die(){ echo -e "\n[âœ—] $*\n" >&2; exit 1; }

need_root() {
  [[ "${EUID}" -eq 0 ]] || die "Run as root: sudo bash $0"
}

apt_update_once() {
  export DEBIAN_FRONTEND=noninteractive
  if [[ -z "${_APT_UPDATED:-}" ]]; then
    apt-get update -y
    _APT_UPDATED=1
  fi
}

install_packages() {
  log "Installing packages (CUDA toolkit, OpenCL loader, python, git, 7z, tools)..."
  apt_update_once
  apt-get install -y \
    nvidia-cuda-toolkit \
    ocl-icd-libopencl1 \
    clinfo \
    p7zip-full \
    python3 \
    python3-venv \
    python3-pip \
    git \
    wget \
    ca-certificates \
    redis-tools \
    tmux
}

ensure_user() {
  if id -u "${WORKER_USER}" >/dev/null 2>&1; then
    log "User ${WORKER_USER} already exists."
  else
    log "Creating user ${WORKER_USER}..."
    useradd -m -s /bin/bash "${WORKER_USER}"
  fi
}

make_dirs() {
  log "Creating /home/hashcat/.hashcat directory layout..."
  mkdir -p \
    "${HASHCAT_DOTDIR}" \
    "${HASHCAT_DOTDIR}/hashz" \
    "${HASHCAT_DOTDIR}/cracked" \
    "${HASHCAT_DOTDIR}/dictionaries" \
    "${HASHCAT_DOTDIR}/hashcat-restores" \
    "${HASHCAT_DOTDIR}/jobs" \
    "${HASHCAT_DOTDIR}/logs" \
    "${HASHCAT_DOTDIR}/masks" \
    "${HASHCAT_DOTDIR}/pots" \
    "${HASHCAT_DOTDIR}/rules" \
    "${HASHCAT_DOTDIR}/sessions" \
    "${HASHCAT_DOTDIR}/tools" \
    "${HASHCAT_DOTDIR}/uploads"

  chown -R "${WORKER_USER}:${WORKER_USER}" "${WORKER_HOME}"
}

install_hashcat() {
  log "Downloading Hashcat ${HASHCAT_VER}..."
  cd /tmp
  rm -f "hashcat-${HASHCAT_VER}.7z"
  wget -O "hashcat-${HASHCAT_VER}.7z" "${HASHCAT_7Z_URL}"

  log "Extracting Hashcat..."
  rm -rf "hashcat-${HASHCAT_VER}"
  7z x "hashcat-${HASHCAT_VER}.7z" >/dev/null

  log "Installing Hashcat to ${HASHCAT_OPT_DIR}..."
  rm -rf "${HASHCAT_OPT_DIR}"
  mv "hashcat-${HASHCAT_VER}" "${HASHCAT_OPT_DIR}"

  log "Symlinking ${HASHCAT_SYMLINK} -> ${HASHCAT_OPT_DIR}/hashcat.bin"
  ln -sfn "${HASHCAT_OPT_DIR}/hashcat.bin" "${HASHCAT_SYMLINK}"
}

clone_or_update_repo() {
  log "Cloning/updating repo into ${REPO_DIR}..."
  if [[ -d "${REPO_DIR}/.git" ]]; then
    (cd "${REPO_DIR}" && git pull --ff-only)
  else
    rm -rf "${REPO_DIR}"
    runuser -u "${WORKER_USER}" -- git clone "${REPO_URL}" "${REPO_DIR}"
  fi
  chown -R "${WORKER_USER}:${WORKER_USER}" "${REPO_DIR}"
}

setup_venv() {
  log "Creating Python venv at ${VENV_DIR}..."
  runuser -u "${WORKER_USER}" -- python3 -m venv "${VENV_DIR}"

  if [[ -f "${REQ_FILE}" ]]; then
    log "Installing Python requirements from ${REQ_FILE}..."
    runuser -u "${WORKER_USER}" -- bash -lc "
      set -e
      source '${VENV_DIR}/bin/activate'
      pip install -U pip
      pip install -r '${REQ_FILE}'
    "
  else
    warn "Requirements file not found: ${REQ_FILE}"
    warn "Your repo must contain requirments.txt or update REQ_FILE."
  fi
}

install_systemd_service() {
  [[ "${INSTALL_SYSTEMD}" == "yes" ]] || { log "Skipping systemd install (INSTALL_SYSTEMD=no)."; return 0; }

  log "Installing systemd service: hashkitty-worker.service"
  cat > /etc/systemd/system/hashkitty-worker.service <<EOF
[Unit]
Description=Hashkitty GPU Worker (cloud_finder gpu-consumer)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=${WORKER_USER}
Group=${WORKER_USER}
WorkingDirectory=${REPO_DIR}
Environment=HOME=${WORKER_HOME}

# Assumes redis is available on 127.0.0.1:6379 via your SSH tunnel.
# Your code should default to that, or be hardcoded accordingly.
ExecStart=${VENV_DIR}/bin/python ${REPO_DIR}/gpu-consumer.py

Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable hashkitty-worker.service
  systemctl restart hashkitty-worker.service || true

  log "Service status:"
  systemctl --no-pager --full status hashkitty-worker.service || true
}

post_notes() {
  log "Done. Next steps:"
  echo "1) Verify GPU:"
  echo "   nvidia-smi"
  echo
  echo "2) Verify hashcat sees OpenCL:"
  echo "   hashcat --version"
  echo "   hashcat -I"
  echo "   clinfo | head -n 60"
  echo
  echo "3) Bring up your Redis tunnel so the worker has redis at 127.0.0.1:6379"
  echo "   (see commands below)"
  echo
  echo "4) If systemd enabled:"
  echo "   journalctl -u hashkitty-worker -f"
}

main() {
  need_root
  install_packages
  ensure_user
  make_dirs
  install_hashcat
  clone_or_update_repo
  setup_venv
  install_systemd_service
  post_notes
}

main "$@"
